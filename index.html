<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lumina</title>
    <!-- Define o favicon usando o mesmo arquivo SVG do logo -->
    <link rel="icon" type="image/svg+xml" href="images/logo.svg">
    <!-- Carrega o Tailwind CSS para estilos r√°pidos e responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega CryptoJS para criptografia dos backups E HASH DE SENHA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* Define a paleta de cores acolhedoras e est√°veis */
        :root {
            --cor-primaria: #07090f;
            --cor-secundaria: #111629;
            --cor-texto: #f1f4ff;
            --cor-ancora: #ff8c42; /* Laranja/√Çmbar para Di√°rio e √¢ncoras */
            --cor-suave: #1f2a3f;
            /* Restaurando a cor azul original para documentos */
            --cor-documento: #42a2ff; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cor-primaria);
            color: var(--cor-texto);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 16px; /* Ajuste para mobile */
            text-transform: lowercase;
        }

        .card {
            background-color: var(--cor-secundaria);
            padding: 20px; /* Ajuste para mobile */
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
        }

        /* Estilo da se√ß√£o principal (a √¢ncora) */
        .main-anchor {
            background-color: #131b33;
            border: 1px solid #1f2742;
        }

        /* Estilo dos marcadores de identidade */
        .marker-tag {
            background-color: var(--cor-ancora);
            color: #0b0d17;
            font-weight: 500;
            padding: 6px 14px; /* Mais padding para touch mobile */
            border-radius: 9999px;
            cursor: default; /* N√£o √© interativo */
        }
        
        /* Custom style for the journal button to use the accent color */
        .journal-button {
            background-color: var(--cor-ancora);
            transition: background-color 0.2s;
        }
        .journal-button:hover:not(:disabled) {
            background-color: #ffb166;
        }

        .journal-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Inputs gerais */
        input[type="text"], textarea, input[type="email"], input[type="password"], input[type="date"], input[type="url"] {
            padding: 10px;
            background-color: #0d1221;
            border: 1px solid #232a40;
            color: var(--cor-texto);
            text-transform: none;
            border-radius: 0.5rem;
        }

        /* Ajuste do √≠cone de data para ser vis√≠vel no tema escuro */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        /* Spinner customizado para a estabiliza√ß√£o */
        .spinner {
            width: 3rem; 
            height: 3rem; 
            border: 6px solid var(--cor-suave); 
            border-top: 6px solid var(--cor-ancora); 
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bg-white\/80 {
            background-color: rgba(13, 19, 36, 0.75) !important;
        }

        .bg-gray-50 {
            background-color: rgba(10, 15, 30, 0.7) !important;
        }

        .border-gray-200 {
            border-color: #2b324a !important;
        }

        .border-gray-300 {
            border-color: #353c55 !important;
        }

        .text-gray-800,
        .text-gray-700 {
            color: var(--cor-texto) !important;
        }

        .text-gray-600 {
            color: #c5cbe6 !important;
        }

        .text-gray-500 {
            color: #9aa3c7 !important;
        }

        .text-gray-400 {
            color: #7c84ac !important;
        }

        input::placeholder,
        textarea::placeholder {
            color: #7c84ac;
            text-transform: none;
        }
        
        /* Estilo para as frases de amor (cita√ß√µes) */
        .love-quote {
            border-left: 4px solid #f687b3; /* Um rosa suave para amor */
        }

        /* Utilit√°rio para controle de visibilidade do login */
        .hidden {
            display: none !important;
        }

        /* Estilo espec√≠fico para o item da escala musical */
        .scale-item {
            border-left-width: 4px;
            transition: background-color 0.2s;
        }
        .scale-item:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        /* Anima√ß√£o suave para o player aparecendo */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Estilo para o documento privado (AJUSTE DE TAMANHO DE FONTE) */
        .document-title-input {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 0.25rem;
            color: var(--cor-documento); /* Azul restaurado */
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent; /* Invis√≠vel at√© focar ou hover */
            padding: 0.25rem 0;
            width: 100%;
            transition: border-color 0.2s;
        }
        .document-title-input:hover {
            border-bottom-color: #2b324a;
        }
        .document-title-input:focus {
            outline: none;
            border-bottom-color: var(--cor-documento);
        }
        
        /* Estilo para o input de data dentro do card de registro */
        .document-date-input {
            background: transparent;
            border: none;
            padding: 0;
            color: #7c84ac;
            font-size: 0.75rem;
            width: auto;
        }
        .document-date-input:focus {
            outline: none;
            color: var(--cor-texto);
        }
    </style>
</head>
<body class="selection:bg-orange-500/40">

    <div class="max-w-4xl w-full space-y-6 sm:space-y-8">

        
        <!-- === 1. TELA DE LOGIN E CADASTRO === -->
        <section id="auth-section" class="card p-8 sm:p-12 text-center max-w-md mx-auto">
            <div class="mb-8">
                <!-- Combina title.svg e logo.svg na mesma linha, usando classes de alinhamento vertical -->
                <h1 class="flex items-center justify-center gap-3 mb-1">
                    <!-- Ajustando o tamanho da imagem title.svg para h-12/sm:h-14 -->
                    <img src="images/title.svg" alt="Lumina Logo Texto" class="h-12 sm:h-14 w-auto">
                    <!-- Ajustando o tamanho do √≠cone logo.svg para ser h-9/sm:h-11 -->
                    <!-- Adicionando bg-transparent para evitar fundo acidental no container do logo -->
                    <span class="h-9 w-9 sm:h-11 sm:w-11 flex items-center justify-center bg-transparent">
                        <img src="images/logo.svg" alt="Lumina Logo √çcone" class="h-full w-full">
                    </span>
                </h1>
                <!-- O tamanho do subt√≠tulo √© alterado de text-base para text-sm -->
                <p class="text-sm text-gray-500 tracking-[0.3em] mt-1">sua √¢ncora emocional</p>
            </div>

            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1 ml-1 uppercase tracking-wider">E-mail</label>
                    <input type="email" id="auth-email" class="w-full p-3 rounded-lg border focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition" placeholder="seu@email.com">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1 ml-1 uppercase tracking-wider">Senha</label>
                    <input type="password" id="auth-password" class="w-full p-3 rounded-lg border focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition" placeholder="******">
                </div>
                
                <div id="auth-error" class="text-red-400 text-sm text-center hidden bg-red-900/20 p-2 rounded border border-red-800/50"></div>

                <div class="pt-4 flex flex-col gap-3">
                    <button onclick="handleLocalLogin()" id="btn-login" class="w-full py-3 journal-button text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg">
                        entrar
                    </button>
                    <button onclick="handleLocalRegister()" id="btn-register" class="w-full py-3 bg-gray-700 text-gray-300 font-medium rounded-xl hover:bg-gray-600 transition">
                        criar nova conta
                    </button>
                </div>
                <p class="text-xs text-center text-gray-600 mt-4">seus dados ficam salvos neste navegador, fa√ßa backup para utilizar em outro dispositivo.</p>
            </div>
        </section>

        
        <!-- === 1B/1C. EXPLICA√á√ÉO CONSOLIDADA (AGORA ABAIXO DO LOGIN) === -->
        <section id="welcome-explanation" class="card p-6 sm:p-8 text-center max-w-md mx-auto space-y-4 border-l-4 border-amber-500/80 bg-cor-secundaria/50">
            <!-- 1. T√≠tulo alterado -->
            <h2 class="text-xl font-bold text-amber-300 mb-4">pra que serve o Lumina? ü§î</h2>
            
            <!-- Par√°grafo 1: Prop√≥sito -->
            <p class="text-sm text-gray-300 leading-relaxed text-justify">
                O lumina √© um aplicativo web voltado para pessoas com <b>Transtorno de Personalidade Borderline</b> (TPB). √© uma ferramenta de apoio di√°rio para fortalecer a <b>autonomia pessoal</b>, funcionando como √¢ncora emocional em momentos de oscila√ß√£o.<br><br>
                Ele oferece um painel √∫nico, discreto e local que permite ao usu√°rio resgatar <b>caracter√≠sticas</b>, <b>valores</b> e <b>registros pessoais</b>, refor√ßando o sentido de continuidade pessoal. aqui voc√™ vai construir:
            </p>

            
            <ul class="text-sm text-gray-300 list-disc list-inside text-left ml-4 space-y-2">
                <li>‚úçÔ∏è Uma <b>frase central</b> de identidade</li>
                <li>üìö <b>Qualidades centrais</b> e <b>valores pessoais</b></li>
                <li>üìù <b>Elementos fixos</b> da personalidade</li>
                <li>üìñ Um di√°rio de continuidade para lembrar-se de <b>verdades est√°veis</b> em dias dif√≠ceis</li>
                <li>‚ù§Ô∏è Uma <b>√Çncora do amor</b>: frases de afirma√ß√£o e carinho</li>
                <li>üìú Um espa√ßo <b>privado</b> para guardar anota√ß√µes importantes</li>
                
                <!-- NOVO ITEM: MOOD MUSICAL COM EXPLICA√á√ÉO COMPLETA -->
                <li>üéµ seu <b>Mood Musical</b>: sinta atrav√©s da m√∫sica para transitar gradualmente entre suas emo√ß√µes, evitando <b>oscila√ß√µes bruscas</b></li>
            </ul>
        </section>

        <!-- Rodap√© de Licen√ßa para a tela de Login -->
        <footer id="auth-footer" class="text-center text-sm py-6 text-gray-500 max-w-4xl mx-auto">
            ¬© 2025 lumina ‚Äî Conte√∫do licenciado sob <b>MIT License</b>.
        </footer>

        <!-- === 2. CONTE√öDO DO APP === -->
        <div id="app-content" class="hidden space-y-6 sm:space-y-8">
            
            <!-- SE√á√ÉO PRINCIPAL - √ÇNCORA DE IDENTIDADE -->
            <section id="main-anchor" class="card main-anchor p-6 sm:p-10 text-center relative">
                <!-- Bot√£o de Sair (Logout) -->
                <button onclick="handleLocalLogout()" class="absolute top-4 right-4 text-xs text-red-400 hover:text-red-300 transition border border-red-900/50 px-3 py-1 rounded-full bg-red-900/20">
                    sair
                </button>

                <div class="mb-6">
                    <h1 class="flex items-center justify-center gap-3 mb-1">
                        <img src="images/title.svg" alt="Lumina Logo Texto" class="h-12 sm:h-14 w-auto">
                        <span class="h-9 w-9 sm:h-11 sm:w-11 flex items-center justify-center bg-transparent">
                            <img src="images/logo.svg" alt="Lumina Logo √çcone" class="h-full w-full">
                        </span>
                    </h1>
                    <p class="text-sm text-gray-500 mt-1 tracking-[0.3em]">
                        sua √¢ncora emocional
                    </p>
                    <!-- Indicador de status -->
                    <div id="loading-status" class="mt-3 text-sm text-amber-400 hidden items-center justify-center gap-2">
                        <div class="spinner w-3 h-3 border-2"></div>
                        carregando...
                    </div>
                    <p id="user-id-display" class="mt-2 text-xs text-gray-400 break-all opacity-50">Usu√°rio: ...</p>
                </div>

                <div class="text-left mb-6">
                    <div class="p-3 rounded-xl bg-white/80">
                        <label class="block text-sm font-medium text-gray-600 mb-1">üí¨ frase central de identidade:</label>
                        <textarea id="identity-sentence-input" rows="2" class="p-2 border rounded-lg w-full resize-none" placeholder="adicione uma frase central. ex: eu n√£o sou meus pensamentos nem minhas emo√ß√µes, mas tenho o direito de sentir."></textarea>
                    </div>
                </div>

                <!-- Qualidades & Valores (Layout adapt√°vel) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div class="p-3 rounded-xl bg-white/80">
                        <h2 class="text-md font-semibold mb-2 border-b pb-1 text-gray-700">‚ú® Tr√™s Qualidades Centrais</h2>
                        <ul id="qualities-list" class="list-disc list-inside pl-2 space-y-1 text-sm mb-3"></ul>
                        <input type="text" id="qualities-input" class="p-2 border rounded-lg w-full text-sm" placeholder="ex: gentil, forte, criativa">
                        <p class="text-[11px] text-gray-500 mt-1">Separe por v√≠rgula (m√°x. 3).</p>
                    </div>
                    <div class="p-3 rounded-xl bg-white/80">
                        <h2 class="text-md font-semibold mb-2 border-b pb-1 text-gray-700">üåü Tr√™s Valores Pessoais</h2>
                        <ul id="values-list" class="list-disc list-inside pl-2 space-y-1 text-sm mb-3"></ul>
                        <input type="text" id="values-input" class="p-2 border rounded-lg w-full text-sm" placeholder="ex: honestidade, liberdade, crescimento">
                        <p class="text-[11px] text-gray-500 mt-1">Separe por v√≠rgula (m√°x. 3).</p>
                    </div>
                </div>

                <!-- Marcadores de Identidade -->
                <div class="mt-6">
                    <h3 class="text-md font-semibold mb-3 text-gray-700">Marcadores de Identidade (Pontos Fixos):</h3>
                    <div id="markers-container" class="flex flex-wrap justify-center gap-2">
                        <!-- Tags ser√£o injetadas aqui -->
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Adicione/edite marcadores (separe por v√≠rgula):</label>
                        <input type="text" id="markers-input" class="p-2 border rounded-lg w-full text-sm" placeholder="ex: m√∫sica, arte, sensibilidade, intui√ß√£o">
                    </div>
                </div>
                
                <!-- Indicador de Status -->
                <div class="mt-6 flex justify-end h-6">
                    <div id="save-status-indicator" class="text-sm font-medium text-gray-500 transition-all duration-500 opacity-0">
                        <!-- Status ser√° injetado aqui -->
                    </div>
                </div>
                
            </section>
            
            
            <!-- 2. SE√á√ÉO: COISAS QUE FAZEM PARTE DE VOC√ä -->
            <section id="fixed-elements-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">Coisas que Fazem Parte de Voc√™</h2>
                <div id="fixed-elements-container" class="space-y-3 max-h-96 overflow-y-auto p-2">
                    <!-- Cards de elementos fixos ser√£o injetados aqui -->
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-fixed-element-input" placeholder="adicione um elemento constante. ex: minha capacidade de amar incondicionalmente." class="p-2 border rounded-lg w-full focus:ring-1 focus:ring-cor-ancora focus:border-cor-ancora">
                    <button onclick="addFixedElement()" class="px-4 py-2 journal-button text-white rounded-lg hover:opacity-90 transition flex-shrink-0">
                        adicionar
                    </button>
                </div>
            </section>

            <!-- 2B. NOVA SE√á√ÉO: COISAS QUE VOC√ä GOSTA -->
            <section id="likes-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">Coisas de que voc√™ Gosta</h2>
                <div id="likes-container" class="space-y-3 max-h-96 overflow-y-auto p-2">
                    <!-- Cards de gostos ser√£o injetados aqui -->
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-like-input" placeholder="adicione um gosto ou interesse. ex: cheiro de chuva." class="p-2 border rounded-lg w-full focus:ring-1 focus:ring-cor-ancora focus:border-cor-ancora">
                    <button onclick="addLikeElement()" class="px-4 py-2 journal-button text-white rounded-lg hover:opacity-90 transition flex-shrink-0">
                        adicionar
                    </button>
                </div>
            </section>
            
            <!-- 2C. NOVA SE√á√ÉO: COISAS QUE VOC√ä N√ÉO GOSTA (Dislikes) -->
            <section id="dislikes-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">Coisas de que Voc√™ N√£o Gosta</h2>
                <p class="text-xs text-gray-500 mb-4 italic p-2 rounded-lg bg-red-900/10 border border-red-900/30">
                    ‚≠ê Dica: Evite focar em defeitos ou coisas que voc√™ n√£o gosta em si mesmo(a). em vez disso, foque no que te desagrada de forma geral para refor√ßar seus limites.  
                </p>
                <div id="dislikes-container" class="space-y-3 max-h-96 overflow-y-auto p-2">
                    <!-- Cards de avers√µes ser√£o injetados aqui -->
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-dislike-input" placeholder="adicione algo de que voc√™ n√£o gosta. ex: a cor laranja." class="p-2 border rounded-lg w-full focus:ring-1 focus:ring-cor-ancora focus:border-cor-ancora">
                    <button onclick="addDislikeElement()" class="px-4 py-2 journal-button text-white rounded-lg hover:opacity-90 transition flex-shrink-0">
                        adicionar
                    </button>
                </div>
            </section>

            <!-- 3. SE√á√ÉO: DI√ÅRIO DE CONTINUIDADE -->
            <section id="journal-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-700">üìñ Di√°rio de Continuidade</h2>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <label for="journal-entry" class="block text-sm font-medium mb-2 italic text-gray-600">
                    adicione uma verdade cont√≠nua sobre voc√™ ou uma a√ß√£o de autocuidado que fez hoje. 
                    </label>
                    <textarea id="journal-entry" rows="3" class="p-2 border rounded-lg w-full resize-none focus:ring-1 focus:ring-cor-ancora focus:border-cor-ancora" placeholder="ex: continuo tendo f√© / hoje acordei cedo e tomei sol."></textarea>
                    <button onclick="addJournalEntry()" class="mt-3 px-4 py-2 journal-button text-white rounded-lg hover:opacity-90 transition">
                        registrar const√¢ncia
                    </button>
                </div>
                
                <div id="journal-entries-container" class="space-y-4 max-h-96 overflow-y-auto p-2">
                    <!-- Entradas do di√°rio ser√£o injetadas aqui -->
                </div>
            </section>
            
            <!-- === 2D. SE√á√ÉO: REGISTROS PESSOAIS (ATUALIZADA) === -->
            <section id="private-docs-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-[var(--cor-documento)] flex items-center gap-2">
                    üìÉ Registros Pessoais
                </h2>
                <p class="text-sm text-gray-500 mb-4">Um espa√ßo seguro para registrar textos ou anota√ß√µes importantes sobre sua jornada.</p>

                <!-- NOVO BLOCO DE REGISTRO PADRONIZADO (Estilo Di√°rio) -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                        <div class="col-span-1 sm:col-span-2">
                            <label class="block text-sm font-medium mb-1 italic text-gray-600">T√≠tulo:</label>
                            <input type="text" id="new-doc-title" class="p-2 border rounded-lg w-full text-sm focus:ring-1 focus:ring-[var(--cor-documento)] focus:border-[var(--cor-documento)]" placeholder="ex: reflex√£o sobre a terapia">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium mb-1 italic text-gray-600">Data:</label>
                            <input type="date" id="new-doc-date" class="border rounded-lg w-full text-base">
                        </div>
                    </div>
                    
                    <label class="block text-sm font-medium mb-1 italic text-gray-600">Conte√∫do:</label>
                    <textarea id="new-doc-content" rows="3" class="p-2 border rounded-lg w-full resize-none focus:ring-1 focus:ring-[var(--cor-documento)] focus:border-[var(--cor-documento)]" placeholder="escreva aqui..."></textarea>
                    
                    <button onclick="addNewPrivateDoc()" class="mt-3 px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-[var(--cor-documento)] hover:bg-blue-600 shadow-lg w-full sm:w-auto">
                        registrar anota√ß√£o
                    </button>
                </div>
                
                <div id="private-docs-container" class="space-y-6 max-h-[70vh] overflow-y-auto p-2">
                    <!-- Os documentos privados ser√£o injetados aqui -->
                </div>
            </section>

            
            <!-- 4. NOVA SE√á√ÉO: √ÇNCORA DO AMOR -->
            <section id="love-anchor-section" class="card">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-pink-400">ü©∑ √Çncora do Amor</h2>
                <p class="text-sm text-gray-500 mb-4">Frases de afirma√ß√£o e carinho ditas por ou para pessoas amadas.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <!-- GRID DE 4 COLUNAS -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <div class="col-span-1 sm:col-span-2">
                            <label for="love-quote-input" class="block text-sm font-medium mb-1 italic text-gray-600">Frase:</label>
                            <textarea id="love-quote-input" rows="2" class="p-2 border rounded-lg w-full  focus:ring-1 focus:ring-pink-400 focus:border-pink-400" placeholder="ex: 'sou grata(o) por ter voc√™ em minha vida.'"></textarea>
                        </div>
                        
                        <div class="col-span-1">
                            <label for="love-date-input" class="block text-sm font-medium mb-1 italic text-gray-600">quando foi dita:</label>
                            <input type="date" id="love-date-input" class="border rounded-lg w-full text-base">
                        </div>
                        
                        <div class="col-span-1">
                            <label for="love-source-input" class="block text-sm font-medium mb-1 italic text-gray-600">Quem disse:</label>
                            <input type="text" id="love-source-input" class="p-2 border rounded-lg w-full text-sm" placeholder="ex: m√£e, amiga, eu">
                        </div>
                    </div>
                    <button onclick="addLoveQuote()" class="mt-3 px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-pink-500 hover:bg-pink-400 shadow-lg">
                        registrar amor
                    </button>
                </div>
                
                <div id="love-quotes-container" class="space-y-4 max-h-96 overflow-y-auto p-2">
                    <!-- Frases de amor ser√£o injetadas aqui -->
                </div>
            </section>
            
            <section id="emotion-scale-section" class="card">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-pink-400 to-yellow-200 w-fit">Mood Musical</h2>
                    <p class="text-xs text-gray-500 italic p-2 rounded-lg bg-gray-900/10 border border-blue-900/30">
                        ‚≠ê dica: Para evitar oscila√ß√µes muito intensas (ex: da raiva para o amor), comece ouvindo a m√∫sica da emo√ß√£o que voc√™ est√° sentindo agora e suba aos poucos, sem pular etapas.
                        Permita-se sentir cada emo√ß√£o e fazer uma transi√ß√£o suave at√© o topo. 
                    </p>
                </div>
                
                <div id="emotion-scale-container" class="space-y-4">
                    <!-- Os itens da escala ser√£o gerados aqui pelo JavaScript -->
                </div>
            </section>

            <!-- SE√á√ÉO DE BACKUP / TRANSFER√äNCIA -->
            <section id="backup-section" class="card bg-gray-800 border border-gray-700">
                <h2 class="text-lg font-semibold mb-4 text-gray-400 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Backup e Transfer√™ncia
                </h2>
                <!-- Texto atualizado para mencionar as op√ß√µes -->
                <p class="text-xs text-gray-500 mb-4">escolha como voc√™ deseja baixar seus dados: com o <b>backup protegido</b>, seus dados s√£o criptografados e s√≥ podem ser visualizados ap√≥s digitar a senha e restaurar seus dados no lumina. j√° o <b>backup simples</b> pode ser visualizado por qualquer pessoa com acesso ao arquivo.</p>
                
                <div class="flex flex-col gap-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="exportEncryptedData()" class="px-4 py-3 bg-blue-600/20 border border-blue-500/50 text-blue-200 font-medium rounded-xl hover:bg-blue-600/30 transition text-sm flex items-center justify-center gap-2">
                            üîí backup protegido (recomendado)
                        </button>
                        
                        <button onclick="exportPlainData()" class="px-4 py-3 bg-amber-600/20 border border-amber-500/50 text-amber-200 font-medium rounded-xl hover:bg-amber-600/30 transition text-sm flex items-center justify-center gap-2">
                            üìÑ backup simples 
                        </button>
                    </div>
                    
                    <button onclick="triggerImport()" class="w-full px-4 py-3 bg-emerald-600/20 border border-emerald-500/50 text-emerald-200 font-medium rounded-xl hover:bg-emerald-600/30 transition text-sm flex items-center justify-center gap-2">
                        ‚¨Ü restaurar dados (upload)
                    </button>
                </div>
                
                <!-- Input file invis√≠vel -->
                <input type="file" id="import-file" accept=".json,.lumina" class="hidden" onchange="handleFileImport(this)">
                <p id="import-status" class="text-xs text-center mt-2 h-4"></p>
            </section>
            
        </div>
        
        <!-- NOVO: Rodap√© principal (vis√≠vel no modo app) -->
        <footer id="app-footer" class="text-center text-sm py-6 text-gray-500 hidden">
            ¬© 2025 lumina ‚Äî Conte√∫do licenciado sob <b>MIT License</b>.
        </footer>
        
    </div>

    <script>
        // --- FUN√á√ïES DE SEGURAN√áA E UTILIT√ÅRIOS ---

        /**
         * @description Higieniza o texto removendo tags HTML e garantindo que o texto seja
         * injetado no DOM apenas como conte√∫do e n√£o como c√≥digo execut√°vel (XSS).
         * @param {string} text - O texto a ser higienizado.
         * @returns {string} O texto com entidades HTML escapadas.
         */
        function sanitizeText(text) {
            if (typeof text !== 'string') return '';
            // Cria um TextNode, permitindo que o navegador fa√ßa o escape de HTML para n√≥s.
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            return tempDiv.innerHTML;
        }

        /**
         * @description Gera um hash SHA-256 da senha.
         * @param {string} password - A senha a ser hasheada.
         * @returns {string} O hash da senha.
         */
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }

        // --- SISTEMA DE ARMAZENAMENTO LOCAL (SEM FIREBASE) ---
        
        // Chaves para o LocalStorage
        const KEYS = {
            USERS: 'lumina_users_v2_hashed', // Onde guardamos login/HASH de senha (ATUALIZADO)
            SESSION: 'lumina_session_user', // Quem est√° logado agora
            DATA_PREFIX: 'lumina_data_' // Prefixo para os dados de cada usu√°rio
        };

        // DADOS PADR√ÉO (ZERADOS/LIMPOS)
        const defaultData = {
            identity_sentence: "",
            qualities: [],
            values: [],
            markers: [],
            fixed_elements: [],
            likes: [],
            dislikes: [], 
            journal: [],
            love_quotes: [],
            emotion_scale: {}, 
            private_docs: [], 
        };

        // Defini√ß√£o da Escala Fixa (ORDEM INVERTIDA)
        const EMOTION_SCALE_DEF = [
            { id: 'paz',      label: '9. paz',      color: 'border-cyan-200',   bg: 'bg-cyan-200/10' },
            { id: 'alegria',  label: '8. alegria',  color: 'border-yellow-400', bg: 'bg-yellow-400/10' },
            { id: 'amor',     label: '7. amor',     color: 'border-pink-500',   bg: 'bg-pink-500/10' },
            { id: 'aceitacao',label: '6. aceita√ß√£o',color: 'border-green-600',  bg: 'bg-green-600/10' },
            { id: 'coragem',  label: '5. coragem',  color: 'border-amber-500',  bg: 'bg-amber-500/10' },
            { id: 'raiva',    label: '4. raiva',    color: 'border-orange-700', bg: 'bg-orange-700/10' },
            { id: 'desejo',   label: '3. desejo',   color: 'border-red-800',    bg: 'bg-red-900/10' },
            { id: 'medo',     label: '2. medo',     color: 'border-indigo-900', bg: 'bg-indigo-900/10' },
            { id: 'tristeza', label: '1. tristeza', color: 'border-blue-900', bg: 'bg-blue-900/10' }
        ];

        // Estado Global
        let currentUser = null;

        
        window.userData = JSON.parse(JSON.stringify(defaultData)); // C√≥pia limpa

        // --- FUN√á√ïES DE BACKUP (CRIPTOGRAFADO E SIMPLES) ---
        
        // OP√á√ÉO 1: Backup Criptografado (Original)
        window.exportEncryptedData = function() {
            if(!currentUser) return;
            
            // 1. Solicita a senha para criptografia
            const password = prompt("üîí prote√ß√£o de backup\n\ncrie uma senha para criptografar este arquivo:");
            
            if (!password) {
                // Se o usu√°rio cancelou ou deixou vazio, aborta para seguran√ßa
                if(password === "") alert("backup cancelado: √© necess√°rio definir uma senha para garantir a seguran√ßa dos seus dados.");
                return;
            }
            if (password.length < 8) {
                alert("backup cancelado: a senha de backup deve ter no m√≠nimo 8 caracteres para ser segura.");
                return;
            }

            // 2. AVISO IMPORTANTE 
            const confirmBackup = confirm("‚ö†Ô∏è se voc√™ perder ou esquecer esta senha, seus dados ser√£o perdidos para sempre. como os dados s√£o criptografados, n√£o h√° 'recupera√ß√£o de senha' poss√≠vel. ‚ö†Ô∏è");
            
            if (!confirmBackup) return;

            const dataStr = JSON.stringify(window.userData);
            
            try {
                // 3. Criptografa os dados usando AES e a senha informada
                const encryptedData = CryptoJS.AES.encrypt(dataStr, password).toString();

                // 4. Salva o arquivo criptografado
                const blob = new Blob([encryptedData], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                // Extens√£o .lumina para indicar que √© um arquivo propriet√°rio/especial
                a.download = `lumina_backup_${sanitizeText(currentUser)}_${new Date().toISOString().slice(0,10)}.lumina`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert("erro ao criptografar os dados. tente novamente.");
            }
        }

        // OP√á√ÉO 2: Backup Simples (JSON - Nova fun√ß√£o)
        window.exportPlainData = function() {
            if(!currentUser) return;

            // Aviso de seguran√ßa
            const confirmPlain = confirm("‚ö†Ô∏è voc√™ escolheu baixar um backup sem criptografia. qualquer pessoa com acesso a este arquivo poder√° ler seus dados.\n\ndeseja continuar?");
            
            if (!confirmPlain) return;

            try {
                // Pretty print (indenta√ß√£o de 2 espa√ßos) para ficar leg√≠vel se a pessoa abrir no bloco de notas
                const dataStr = JSON.stringify(window.userData, null, 2);
                
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                // Extens√£o .json padr√£o
                a.download = `lumina_dados_${sanitizeText(currentUser)}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert("erro ao gerar o arquivo JSON. tente novamente.");
            }
        }

        window.triggerImport = function() {
            document.getElementById('import-file').click();
        }

        window.handleFileImport = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            const statusEl = document.getElementById('import-status');
            
            statusEl.textContent = "lendo arquivo...";
            statusEl.className = "text-xs text-center mt-2 h-4 text-amber-400";

            reader.onload = function(e) {
                let importedData = null;
                const fileContent = e.target.result;

                try {
                    // TENTATIVA 1: Tenta ler como JSON normal (Backup Simples)
                    importedData = JSON.parse(fileContent);
                } catch (jsonError) {
                    // Se der erro no JSON.parse, assumimos que est√° criptografado (ou √© lixo).
                    // TENTATIVA 2: Pedir a senha e descriptografar (Backup Protegido)
                    const password = prompt("üîê arquivo protegido\n\neste backup est√° criptografado. digite a senha para desbloquear:");
                    
                    if (password) {
                        try {
                            const bytes = CryptoJS.AES.decrypt(fileContent, password);
                            const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                            
                            if (!decryptedString) throw new Error("Senha incorreta ou arquivo corrompido");
                            
                            importedData = JSON.parse(decryptedString);
                        } catch (cryptoError) {
                            alert("senha incorreta ou arquivo inv√°lido.");
                            statusEl.textContent = "erro: senha incorreta.";
                            statusEl.className = "text-xs text-center mt-2 h-4 text-red-400";
                            input.value = '';
                            return;
                        }
                    } else {
                        statusEl.textContent = "Importa√ß√£o cancelada.";
                        input.value = '';
                        return;
                    }
                }

                try {
                    // Valida√ß√£o b√°sica para ver se √© um arquivo do Lumina
                    // Verifica se tem pelo menos um campo conhecido ou se √© um objeto vazio v√°lido
                    if (importedData && typeof importedData === 'object') {
                        // Sucesso! Atualiza a mem√≥ria
                        // Fazemos merge com defaultData para garantir que campos novos (como 'dislikes') existam mesmo em backups antigos
                        window.userData = { ...defaultData, ...importedData };
                        
                        // Garante que arrays existam se vierem null
                        if(!window.userData.qualities) window.userData.qualities = [];
                        if(!window.userData.values) window.userData.values = [];
                        
                        // Salva no disco local imediatamente
                        saveData(); 
                        // Atualiza a tela
                        renderAll();
                        populateInlineInputs();
                        
                        statusEl.textContent = "Dados restaurados com sucesso!";
                        statusEl.className = "text-xs text-center mt-2 h-4 text-green-400";
                        
                        // Limpa a mensagem depois de 3s
                        setTimeout(() => statusEl.textContent = "", 3000);
                    } else {
                        throw new Error("Formato inv√°lido");
                    }
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = "Erro: O arquivo n√£o parece ser um backup v√°lido do Lumina.";
                    statusEl.className = "text-xs text-center mt-2 h-4 text-red-400";
                }
                // Limpa o input para permitir re-upload do mesmo arquivo se precisar
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- FUN√á√ïES DE AUTENTICA√á√ÉO LOCAL (COM HASH DE SENHA) ---

        function getUsersDB() {
            const users = localStorage.getItem(KEYS.USERS);
            return users ? JSON.parse(users) : {};
        }

        function saveUsersDB(users) {
            localStorage.setItem(KEYS.USERS, JSON.stringify(users));
        }

        window.handleLocalRegister = function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');

            if(!email || !password) {
                showError("Preencha e-mail e senha.");
                return;
            }
            // Aumentando o m√≠nimo de senha para 6
            if(password.length < 6) { 
                showError("A senha deve ter no m√≠nimo 6 caracteres.");
                return;
            }

            const users = getUsersDB();
            if(users[email]) {
                showError("Usu√°rio j√° existe. Tente entrar.");
                return;
            }

            // CORRE√á√ÉO DE SEGURAN√áA: Armazena o hash da senha
            const passwordHash = hashPassword(password);

            // Cria usu√°rio com hash
            users[email] = { hash: passwordHash, createdAt: new Date().toISOString() };
            saveUsersDB(users);

            // Loga automaticamente
            loginUser(email);
        };

        window.handleLocalLogin = function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;

            if(!email || !password) {
                showError("Preencha e-mail e senha.");
                return;
            }

            const users = getUsersDB();
            const userRecord = users[email];
            
            if(userRecord) {
                // CORRE√á√ÉO DE SEGURAN√áA: Hasheia a senha digitada para compara√ß√£o
                const inputHash = hashPassword(password);

                // Compara o hash de entrada com o hash armazenado
                if (userRecord.hash === inputHash) {
                    loginUser(email);
                    return;
                }
            } 
            
            showError("E-mail ou senha incorretos.");
        };

        window.handleLocalLogout = function() {
            localStorage.removeItem(KEYS.SESSION);
            currentUser = null;
            
            // Limpa UI
            document.getElementById('auth-email').value = '';
            document.getElementById('auth-password').value = '';
            
            // Esconde conte√∫do do app
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('app-footer').classList.add('hidden');

            // Mostra tela de login/explica√ß√£o
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('welcome-explanation').classList.remove('hidden');
            document.getElementById('auth-footer').classList.remove('hidden'); // MOSTRAR NO LOGOUT
        };

        function loginUser(email) {
            currentUser = email;
            localStorage.setItem(KEYS.SESSION, email);
            
            document.getElementById('auth-error').classList.add('hidden');
            
            // Esconde tela de login/explica√ß√£o
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('welcome-explanation').classList.add('hidden');
            document.getElementById('auth-footer').classList.add('hidden'); // ESCONDER NO LOGIN

            // Mostra conte√∫do do app
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('app-footer').classList.remove('hidden'); // MOSTRAR NO LOGIN
            
            // CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o e-mail antes de injetar no DOM (embora seja s√≥ um e-mail, √© boa pr√°tica)
            document.getElementById('user-id-display').textContent = `Usu√°rio: ${sanitizeText(email)}`;
            
            loadData();
        }

        function showError(msg) {
            const div = document.getElementById('auth-error');
            div.textContent = msg;
            div.classList.remove('hidden');
        }

        // --- SISTEMA DE DADOS ---

        function loadData() {
            if(!currentUser) return;
            
            const key = KEYS.DATA_PREFIX + currentUser;
            const saved = localStorage.getItem(key);
            
            if(saved) {
                // Merge com cuidado para n√£o perder campos novos se a estrutura mudar
                window.userData = { ...defaultData, ...JSON.parse(saved) };
            } else {
                window.userData = JSON.parse(JSON.stringify(defaultData));
                saveData(); // Salva o inicial
            }

            renderAll();
            populateInlineInputs();
        }

        const saveStatusEl = document.getElementById('save-status-indicator');

        function saveData() {
            if(!currentUser) return;

            try {
                const key = KEYS.DATA_PREFIX + currentUser;
                localStorage.setItem(key, JSON.stringify(window.userData));
                
                // Feedback Visual
                if (saveStatusEl) {
                    saveStatusEl.classList.remove('opacity-0');
                    saveStatusEl.innerHTML = '<span class="text-green-400">Salvo!</span>';
                    setTimeout(() => {
                        saveStatusEl.classList.add('opacity-0');
                    }, 1500);
                }
            } catch (e) {
                console.error("Erro ao salvar localmente", e);
                if (saveStatusEl) {
                    saveStatusEl.classList.remove('opacity-0');
                    saveStatusEl.innerHTML = '<span class="text-red-400">Erro (Espa√ßo cheio?)</span>';
                }
            }
        }

        // Debounce para n√£o salvar a cada letra
        function debounce(func, timeout = 500) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        const debouncedSave = debounce(saveData, 1000);
        window.saveDataToFirestore = saveData; // Mantendo o nome antigo para compatibilidade do bot√£o manual

        // --- RENDERIZA√á√ÉO DA UI (Com Sanitiza√ß√£o) ---

        const cleanAndSplit = (value, limit = Infinity) => {
            return (value || "").split(',').map(s => s.trim()).filter(s => s.length > 0).slice(0, limit);
        };

        function renderAll() {
            renderList('qualities-list', window.userData.qualities);
            renderList('values-list', window.userData.values);
            renderMarkers();
            renderPrivateDocs(); 
            renderFixedElements();
            renderLikes();
            renderDislikes(); 
            renderJournal();
            renderLoveQuotes();
            renderEmotionScale(); 
        }
        
        // --- L√ìGICA DA ESCALA MUSICAL ---
        
        // Converte links normais em links de embed de forma robusta
        function getEmbedUrl(url) {
            if (!url) return null;
            try {
                // Spotify (REGRA NOVA PARA IGNORAR PA√çS)
                if (url.includes('spotify.com')) {
                    // Regex captura:
                    // 1. O tipo (track, album, playlist, episode)
                    // 2. O ID (alfanum√©rico)
                    // Ignora prefixos como /intl-pt/ ou /intl-ja/
                    const match = url.match(/spotify\.com\/(?:intl-[a-z-]+\/)?(track|album|playlist|episode)\/([a-zA-Z0-9]+)/);
                    if (match && match.length >= 3) {
                        return `https://open.spotify.com/embed/${match[1]}/${match[2]}`;
                    }
                    // Se j√° for embed, deixa como est√°
                    if (url.includes('/embed')) return url;
                }
                
                // Apple Music
                if (url.includes('music.apple.com') && !url.includes('embed.')) {
                    return url.replace('music.apple.com', 'embed.music.apple.com');
                }
                // YouTube (b√°sico)
                if (url.includes('youtube.com/watch?v=')) {
                    const videoId = url.split('v=')[1].split('&')[0];
                    return `https://www.youtube.com/embed/${videoId}`;
                }
                if (url.includes('youtu.be/')) {
                    const videoId = url.split('youtu.be/')[1].split('?')[0];
                    return `https://www.youtube.com/embed/${videoId}`;
                }
                
                // CORRE√á√ÉO DE SEGURAN√áA: N√£o injeta URL sem sanitiza√ß√£o no iframe src
                // Embora iframes tenham prote√ß√£o nativa, for√ßamos que apenas URLs v√°lidas de embed sejam usadas.
                // Aqui, apenas retorna a URL original se n√£o for de embed conhecida.
                return url; 
            } catch (e) {
                console.error("Erro ao converter URL", e);
                return url;
            }
        }

        function renderEmotionScale() {
            const container = document.getElementById('emotion-scale-container');
            if(!window.userData.emotion_scale) window.userData.emotion_scale = {};

            container.innerHTML = EMOTION_SCALE_DEF.map(item => {
                const savedItem = window.userData.emotion_scale[item.id] || { link: '' }; // Removemos o 'name'
                const embedUrl = getEmbedUrl(savedItem.link);
                const hasEmbed = embedUrl && (embedUrl.includes('embed') || embedUrl.includes('youtube'));

                // L√≥gica de altura din√¢mica
                let heightClass = "h-20 sm:h-[80px]"; // Padr√£o (Spotify compact)
                
                if (embedUrl) {
                    if (embedUrl.includes('music.apple.com')) {
                        heightClass = "h-[150px]"; // Apple Music precisa de mais altura
                    } else if (embedUrl.includes('youtube') || embedUrl.includes('youtu.be')) {
                        heightClass = "h-[200px]"; // YouTube fica melhor maior
                    }
                }

                // CORRE√á√ÉO DE SEGURAN√áA: O link salvo √© usado como 'value' no input. O valor de entrada deve ser sanitizado.
                // O valor do input √© recuperado via .value, ent√£o n√£o √© um risco de XSS direto na inje√ß√£o.
                // Mas a URL do embed √© injetada. Como getEmbedUrl verifica o protocolo, mantemos assim.
                return `
                <div class="scale-item p-4 rounded-lg bg-gray-800/40 ${item.color} border-l-4">
                    <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mb-2">
                        <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o label -->
                        <span class="text-sm font-bold text-gray-400 w-28 flex-shrink-0">${sanitizeText(item.label)}</span>
                        
                        <!-- Input √önico agora -->
                        <div class="flex-grow w-full">
                            <input type="url" 
                                placeholder="que m√∫sica te faz sentir assim? cole o link do spotify, apple music ou youtube."
                                class="w-full bg-transparent border-b border-gray-700 focus:border-amber-500 outline-none text-sm p-1 text-gray-500 focus:text-gray-300 placeholder-gray-600 transition-colors"
                                value="${sanitizeText(savedItem.link || '')}"
                                onchange="updateEmotion('${item.id}', 'link', this.value)"
                            >
                        </div>
                    </div>
                    
                    ${hasEmbed ? `
                    <div class="mt-3 w-full ${heightClass} rounded overflow-hidden shadow-lg animate-fade-in">
                        <!-- O src do iframe j√° foi verificado para ser uma URL de embed conhecida -->
                        <iframe style="border-radius:12px" src="${embedUrl}" width="100%" height="100%" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function renderList(id, items) {
            const ul = document.getElementById(id);
            const safeItems = Array.isArray(items) ? items : [];
            // CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar
            ul.innerHTML = safeItems.map(item => `<li class="text-gray-700">${sanitizeText(item.trim())}</li>`).join('');
        }

        function renderMarkers() {
            const container = document.getElementById('markers-container');
            const items = Array.isArray(window.userData.markers) ? window.userData.markers : [];
            // CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar
            container.innerHTML = items.map(marker => `<span class="marker-tag text-sm">${sanitizeText(marker.trim())}</span>`).join('');
        }

        function populateInlineInputs() {
            // CORRE√á√ÉO DE SEGURAN√áA: Usa sanitizeText ao preencher inputs para garantir seguran√ßa caso os dados
            // brutos armazenados contenham c√≥digo malicioso de um ataque XSS anterior.
            const i1 = document.getElementById('identity-sentence-input'); if(i1) i1.value = sanitizeText(window.userData.identity_sentence || '');
            const i2 = document.getElementById('qualities-input'); if(i2) i2.value = sanitizeText((window.userData.qualities || []).join(', '));
            const i3 = document.getElementById('values-input'); if(i3) i3.value = sanitizeText((window.userData.values || []).join(', '));
            const i4 = document.getElementById('markers-input'); if(i4) i4.value = sanitizeText((window.userData.markers || []).join(', '));
        }

        function setupInlineInputs() {
            const setup = (id, field, isArray, limit) => {
                const el = document.getElementById(id);
                if(!el) return;
                el.addEventListener('input', (e) => {
                    // O valor bruto √© sempre salvo. A sanitiza√ß√£o ocorre no display/render.
                    if(isArray) {
                        window.userData[field] = cleanAndSplit(e.target.value, limit);
                        // Re-render immediately for preview
                        if(field === 'qualities' || field === 'values') renderList(id.replace('input', 'list'), window.userData[field]);
                        if(field === 'markers') renderMarkers();
                    } else {
                        window.userData[field] = e.target.value;
                    }
                    
                    // Save Logic
                    const isComma = (e.data === ',') || (e.target.value.trim().endsWith(','));
                    if (isComma && isArray) saveData(); else debouncedSave();
                });
            };

            setup('identity-sentence-input', 'identity_sentence', false);
            setup('qualities-input', 'qualities', true, 3);
            setup('values-input', 'values', true, 3);
            setup('markers-input', 'markers', true);
        }

        // --- L√ìGICA DE DOCUMENTOS PRIVADOS (COM ID √öNICO PARA REMO√á√ÉO) ---

        // Fun√ß√£o para adicionar novo documento a partir do bloco superior
        window.addNewPrivateDoc = function() {
            const tIn = document.getElementById('new-doc-title');
            const dIn = document.getElementById('new-doc-date');
            const cIn = document.getElementById('new-doc-content');

            const title = tIn.value.trim();
            const content = cIn.value.trim();
            // Pega a data ou usa a data de hoje como fallback
            const date = dIn.value || new Date().toISOString().split('T')[0];

            // Permite salvar apenas se houver t√≠tulo ou conte√∫do
            if (title || content) {
                if(!Array.isArray(window.userData.private_docs)) window.userData.private_docs = [];
                
                const doc = {
                    // Mant√©m ID √∫nico para remo√ß√£o mais segura
                    id: Date.now(), 
                    title: title,
                    date: date,
                    content: content
                };
                
                window.userData.private_docs.unshift(doc);
                
                // Limpa os campos
                tIn.value = '';
                cIn.value = '';
                dIn.value = ''; // Limpa a data visualmente
                
                saveData();
                renderPrivateDocs();
            }
        }

        window.updateDocField = function(id, field, value) {
            const docIndex = window.userData.private_docs.findIndex(doc => doc.id == id);
            if (docIndex !== -1) {
                window.userData.private_docs[docIndex][field] = value;
                debouncedSave(); // Salva automaticamente com debounce
            }
        }

        window.removePrivateDoc = function(id) {
            const originalLength = window.userData.private_docs.length;
            // Usa o ID para remover (mais seguro que usar √≠ndice)
            window.userData.private_docs = window.userData.private_docs.filter(doc => doc.id != id); 
            if (window.userData.private_docs.length < originalLength) {
                saveData();
                renderPrivateDocs();
            }
        }

        function renderPrivateDocs() {
            const container = document.getElementById('private-docs-container');
            const items = window.userData.private_docs || [];
            if(items.length === 0) { 
                container.innerHTML = '<p class="text-center italic text-gray-500">Nenhum registro.</p>'; 
                return; 
            }
            
            container.innerHTML = items.map(doc => `
                <div class="card p-6 border-l-4 border-[var(--cor-documento)] space-y-3 relative group">
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-start gap-2">
                             <!-- T√≠tulo Edit√°vel -->
                             <input type="text" 
                                class="document-title-input text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-700 focus:border-[var(--cor-documento)] transition-colors w-full"
                                value="${sanitizeText(doc.title || '')}"
                                oninput="updateDocField(${doc.id}, 'title', this.value)"
                                placeholder="sem t√≠tulo"
                            >
                             <!-- Bot√£o Remover -->
                             <button onclick="removePrivateDoc(${doc.id})" class="text-red-500 hover:text-red-700 p-1 flex-shrink-0 opacity-80 hover:opacity-100" title="remover">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                            </button>
                        </div>
                        
                        <!-- Data Edit√°vel (aparece logo abaixo do t√≠tulo) -->
                         <input type="date" 
                                class="document-date-input"
                                value="${sanitizeText(doc.date || '')}"
                                onchange="updateDocField(${doc.id}, 'date', this.value)"
                        >

                        <!-- Conte√∫do Edit√°vel -->
                        <textarea 
                            id="doc-content-${doc.id}"
                            class="p-3 border rounded-lg w-full resize-y min-h-[150px] bg-cor-secundaria/50 focus:ring-1 focus:ring-[var(--cor-documento)] focus:border-[var(--cor-documento)] text-sm mt-1" 
                            oninput="updateDocField(${doc.id}, 'content', this.value)"
                            placeholder="conte√∫do do documento..."
                        >${sanitizeText(doc.content || '')}</textarea>
                    </div>
                </div>
            `).join('');
        }
        
        // --- FIM L√ìGICA DE DOCUMENTOS PRIVADOS ---


        // --- ADD/REMOVE FUNCTIONS (VOLTANDO AO √çNDICE) ---

        window.addFixedElement = function() {
            const input = document.getElementById('new-fixed-element-input');
            const val = input.value.trim();
            if(val) {
                if(!Array.isArray(window.userData.fixed_elements)) window.userData.fixed_elements = [];
                // Voltando a armazenar apenas o texto
                window.userData.fixed_elements.push(val); 
                input.value = '';
                saveData(); renderFixedElements();
            }
        }
        window.removeFixedElement = function(i) {
            // Voltando a remover por √≠ndice (i)
            window.userData.fixed_elements.splice(i, 1);
            saveData(); renderFixedElements();
        }
        function renderFixedElements() {
            const container = document.getElementById('fixed-elements-container');
            // Renderiza o item com o √≠ndice para a fun√ß√£o de remo√ß√£o
            container.innerHTML = (window.userData.fixed_elements || []).map((item, i) => `
                <div class="card p-3 flex justify-between items-center bg-cor-secundaria/50 text-sm">
                    <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar -->
                    <p class="font-medium text-gray-800">${sanitizeText(item)}</p>
                    <button onclick="removeFixedElement(${i})" class="text-red-500 hover:text-red-700 ml-4">&times;</button>
                </div>
            `).join('');
        }

        window.addLikeElement = function() {
            const input = document.getElementById('new-like-input');
            const val = input.value.trim();
            if(val) {
                if(!Array.isArray(window.userData.likes)) window.userData.likes = [];
                // Voltando a armazenar apenas o texto
                window.userData.likes.push(val); 
                input.value = '';
                saveData(); renderLikes();
            }
        }
        window.removeLikeElement = function(i) {
            // Voltando a remover por √≠ndice (i)
            window.userData.likes.splice(i, 1);
            saveData(); renderLikes();
        }
        function renderLikes() {
            const container = document.getElementById('likes-container');
            // Renderiza o item com o √≠ndice para a fun√ß√£o de remo√ß√£o
            container.innerHTML = (window.userData.likes || []).map((item, i) => `
                <div class="card p-3 flex justify-between items-center bg-cor-secundaria/50 text-sm">
                    <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar -->
                    <p class="font-medium text-gray-800">${sanitizeText(item)}</p>
                    <button onclick="removeLikeElement(${i})" class="text-red-500 hover:text-red-700 ml-4">&times;</button>
                </div>
            `).join('');
        }

        // --- BLOCO PARA DISLIKES ---
        window.addDislikeElement = function() {
            const input = document.getElementById('new-dislike-input');
            const val = input.value.trim();
            if(val) {
                if(!Array.isArray(window.userData.dislikes)) window.userData.dislikes = [];
                // Voltando a armazenar apenas o texto
                window.userData.dislikes.push(val);
                input.value = '';
                saveData(); renderDislikes();
            }
        }
        window.removeDislikeElement = function(i) {
            // Voltando a remover por √≠ndice (i)
            window.userData.dislikes.splice(i, 1);
            saveData(); renderDislikes();
        }
        function renderDislikes() {
            const container = document.getElementById('dislikes-container');
            // Renderiza o item com o √≠ndice para a fun√ß√£o de remo√ß√£o
            container.innerHTML = (window.userData.dislikes || []).map((item, i) => `
                <div class="card p-3 flex justify-between items-center bg-cor-secundaria/50 text-sm border-l-4 border-red-500">
                    <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar -->
                    <p class="font-medium text-gray-800">${sanitizeText(item)}</p>
                    <button onclick="removeDislikeElement(${i})" class="text-red-500 hover:text-red-700 ml-4">&times;</button>
                </div>
            `).join('');
        }
        // --- FIM BLOCO DISLIKES ---


        window.addJournalEntry = function() {
            const txt = document.getElementById('journal-entry');
            const val = txt.value.trim();
            if(val) {
                if(!Array.isArray(window.userData.journal)) window.userData.journal = [];
                // Voltando a armazenar sem ID √∫nico
                window.userData.journal.push({ date: new Date().toISOString().split('T')[0], entry: val });
                txt.value = '';
                saveData(); renderJournal();
            }
        }
        window.removeJournalEntry = function(originalIndex) {
             // Voltando a remover por √≠ndice (i)
             window.userData.journal.splice(originalIndex, 1);
             saveData(); renderJournal();
        }
        function renderJournal() {
            const container = document.getElementById('journal-entries-container');
            const items = window.userData.journal || [];
            if(items.length === 0) { container.innerHTML = '<p class="text-center italic text-gray-500">Nenhum registro.</p>'; return; }
            
            // Renderiza em ordem inversa (mais recente primeiro)
            const reversed = [...items].reverse(); 

            container.innerHTML = reversed.map((entry, i) => {
                // Calcula o √≠ndice real no array original para o bot√£o de remo√ß√£o
                const originalIndex = items.length - 1 - i;
                const date = new Date(entry.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
                return `
                    <div class="card p-4 border-l-4 border-cor-ancora text-sm flex justify-between items-start">
                        <div>
                            <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar -->
                            <p class="text-xs text-gray-500 mb-1">${sanitizeText(date)}</p>
                            <p class="text-base text-gray-700">${sanitizeText(entry.entry)}</p>
                        </div>
                        <button onclick="removeJournalEntry(${originalIndex})" class="text-red-500 hover:text-red-700 ml-4">&times;</button>
                    </div>
                `;
            }).join('');
        }

        window.addLoveQuote = function() {
            const qIn = document.getElementById('love-quote-input');
            const sIn = document.getElementById('love-source-input');
            const dIn = document.getElementById('love-date-input'); 

            const q = qIn.value.trim();
            const s = sIn.value.trim();
            const d = dIn.value.trim() || new Date().toISOString().split('T')[0]; 
            
            if(q) {
                if(!Array.isArray(window.userData.love_quotes)) window.userData.love_quotes = [];
                // Voltando a armazenar sem ID √∫nico
                window.userData.love_quotes.push({ quote: q, source: s || "Voc√™", date: d });
                
                // NOTA: A ordena√ß√£o ser√° feita no render
                
                qIn.value = ''; 
                sIn.value = '';
                dIn.value = ''; 
                
                saveData(); 
                renderLoveQuotes();
            }
        }
        window.removeLoveQuote = function(originalIndex) {
            // Voltando a remover por √≠ndice (i)
            window.userData.love_quotes.splice(originalIndex, 1);
            saveData(); renderLoveQuotes();
        }
        function renderLoveQuotes() {
            const container = document.getElementById('love-quotes-container');
            const items = window.userData.love_quotes || [];
            if(items.length === 0) { container.innerHTML = '<p class="text-center italic text-gray-500">Nenhuma frase.</p>'; return; }
            
            // Ordena os itens por data de forma decrescente (mais recentes primeiro)
            const sortedItems = [...items].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedItems.map((item) => {
                // Procurar o √≠ndice real no array original (n√£o ordenado por data) para a fun√ß√£o de remo√ß√£o
                const originalIndex = items.findIndex(original => 
                    original.quote === item.quote && original.date === item.date && original.source === item.source
                );
                
                // Formata a data para exibi√ß√£o (apenas dia e m√™s para ser conciso)
                const date = new Date(item.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                return `
                    <div class="card p-4 love-quote text-sm flex justify-between items-start">
                        <div>
                            <!-- CORRE√á√ÉO DE SEGURAN√áA: Sanitiza o texto antes de injetar -->
                            <p class="text-lg italic text-gray-700 leading-snug">"${sanitizeText(item.quote)}"</p>
                            <p class="text-xs text-gray-500 mt-1">- ${sanitizeText(item.source)} <span class="ml-2">(${sanitizeText(date)})</span></p>
                        </div>
                        <button onclick="removeLoveQuote(${originalIndex})" class="text-red-500 hover:text-red-700 ml-4">&times;</button>
                    </div>
                `;
            }).join('');
        }

        // --- INICIALIZA√á√ÉO ---

        function initApp() {
            // Adiciona o ajuste de estilo para o input[type="date"] no tema escuro
            const style = document.createElement('style');
            style.textContent = `
                input[type="date"]::-webkit-calendar-picker-indicator {
                    filter: invert(0.8) !important;
                }
            `;
            document.head.appendChild(style);


            setupInlineInputs();
            
            // Tenta login autom√°tico (Sess√£o persistente simples)
            const sessionUser = localStorage.getItem(KEYS.SESSION);
            if(sessionUser) {
                loginUser(sessionUser);
            } else {
                // Estado inicial: Mostra login/explica√ß√£o e seu rodap√©
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('welcome-explanation').classList.remove('hidden');
                document.getElementById('auth-footer').classList.remove('hidden');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

    </script>
</body>
</html>